<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>CS 640 Program 4</title>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<link rel="icon" type="image/icon" href="/favicon.ico"/>
</head>
<body>
	<h1>IP Data</h1>
	<hr>
	<div id='updateDiv'></div>
	<h1>Device Data</h1>
	<hr>
	<div id='updateBrowserDiv'></div>
	<h1>Distance</h1>
	<hr>
	<div id='updateDistance'></div>
	<script type="application/javascript">
	function getgeoip(json) {
		var lat = json.latitude;
		var lon = json.longitude;
		var newParagraph = document.createElement('p');
		newParagraph.innerHTML += "Location determined by IP (" + json.ip + ")" + "<br>";
		newParagraph.innerHTML += "Latitude: " + lat + "<br>";
		newParagraph.innerHTML += "Longitude: " + lon + "<br>";
		document.getElementById("updateDiv").appendChild(newParagraph);
		getWeather(lat, lon, "updateDiv");
		getBrowserIp(lat, lon);
	};
	function getBrowserIp(lat, lon) {
		navigator.geolocation.getCurrentPosition(showMap);
		function showMap(position) {
			var browserlat = position.coords.latitude;
			var browserlon = position.coords.longitude;
			var newParagraph = document.createElement('p');
			newParagraph.innerHTML += "Latitude: " + browserlat + "<br>";
			newParagraph.innerHTML += "Longitude: " + browserlon +"<br>";
			document.getElementById("updateBrowserDiv").appendChild(newParagraph);
			getWeather(browserlat, browserlon, "updateBrowserDiv");
			getDistance(lat, lon, browserlat, browserlon);
		};
	};
	function getWeather(lat, lon, div) {
		$.getJSON("http://api.openweathermap.org/data/2.5/weather?lat=" + lat + "&lon=" + lon, function(json) {
			var newParagraph = document.createElement('p');
			newParagraph.innerHTML += "Nearby weather:" + "<br>";
			newParagraph.innerHTML += "Temperature: " + (json.main.temp - 273.15) + " °C<br>";
			newParagraph.innerHTML += "Wind speed: " + json.wind.speed + " m/s<br>";
			document.getElementById(div).appendChild(newParagraph);
			getBusStops(lat, lon, div);
		});
	};
	function getBusStops(lat, lon, div) {
		$.getJSON("http://api.smsmybus.com/v1/getnearbystops?key=uwcompsci&lat=" + lat + "&lon=" + lon + "&callback=?", function(json) {
			var newParagraph = document.createElement('p');
			if (json.stop.length == 0) {
				newParagraph.innerHTML += "No bus stops available nearby!";
			} else {
				if (json.stop.length == 1) {
					newParagraph.innerHTML += "1 bus stop available nearby!<br>";
				} else {
					newParagraph.innerHTML += json.stop.length + " bus stops available nearby!<br>";
				}
				for (var i = 0; i < json.stop.length; i++) {
					newParagraph.innerHTML += "Stop ID: " + json.stop[i].stopID + "<br>" + "Intersection: " + json.stop[i].intersection + "<br>";
				}
			}
			document.getElementById(div).appendChild(newParagraph);
		});
	};
	function getDistance(lat, lon, browserlat, browserlon) {
		var newParagraph = document.createElement('p');
		if (lat != null && lon != null && browserlat != null && browserlon != null) {
			var R = 6371;
			var φ1 = lat * Math.PI / 180;
			var φ2 = browserlat * Math.PI / 180;
			var Δφ = (browserlat-lat) * Math.PI / 180;
			var Δλ = (browserlon-lon) * Math.PI / 180;
			var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
			Math.cos(φ1) * Math.cos(φ2) *
			Math.sin(Δλ/2) * Math.sin(Δλ/2);
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
			var d = R * c;
			newParagraph.innerHTML += "Distance: " + d + " km<br>";
			document.getElementById("updateDistance").appendChild(newParagraph);
		} else {
			newParagraph.innerHTML += "N/A<br>";
			document.getElementById("updateDistance").appendChild(newParagraph);
		}
	};
	</script>
	<script type="application/javascript" src="http://www.telize.com/geoip?callback=getgeoip"></script>
</body>
</html>
